<?xml version="1.0" ?>

<!-- Attempt at invoking make from the current buffer's directory -->
<!--  Jeff Jackowski (http://ro.com/~jeffj), Jan 22, 2004 -->

<!DOCTYPE COMMANDO SYSTEM "commando.dtd">

<COMMANDO>
	<UI>
		<CAPTION LABEL="Makefile settings (if applicable)">
			<ENTRY LABEL="Rule name" VARNAME="ruleName" DEFAULT=""/>
			<ENTRY LABEL="Makefile name" VARNAME="makefile" DEFAULT="Makefile"/>
			<TOGGLE LABEL="Search for Makefile" VARNAME="search" DEFAULT="true"/>
		</CAPTION>
		<CAPTION LABEL="Advanced">
			<ENTRY LABEL="Additional parameters" VARNAME="params" DEFAULT=""/>
		</CAPTION>
	</UI>

	<COMMANDS>
		<COMMAND SHELL="System" CONFIRM="FALSE">
			buf = new StringBuffer();
			fileTarget = MiscUtilities.getFileNameNoExtension(buffer.getName());

			file = new File(makefile);
			if (!search || file.exists()) {
				buf.append("make");

				if (file.exists()) {
					buf.append(" -f \""+makefile+"\"");
					if (!ruleName.equals(""))
						buf.append(" "+ruleName);
				}
				else
					buf.append(" \""+fileTarget+"\"");

				if (!params.equals(""))
					buf.append(" "+params);

				return buf.toString();
			}
			else {
				dir = buffer.getDirectory();
				file = new File(dir, makefile);
				while (!file.exists()) {
					newDir = MiscUtilities.getParentOfPath(dir);
					if (newDir == dir) {
						// we've reached the top, no point in continuing
						dir = null;
						break;
					}
					dir = newDir;
					file = new File(dir, makefile);
				}

				if (dir != null) {
					buf.append("(cd \""+dir+"\" &amp;&amp; make -f \""+makefile+"\"");
					if (!ruleName.equals(""))
						buf.append(" "+ruleName);
				}
				else
					buf.append("make \""+fileTarget+"\"");

				if (!params.equals(""))
					buf.append(" "+params);

				if (dir != null) buf.append(")");
				return buf.toString();
			}
		</COMMAND>
	</COMMANDS>
</COMMANDO>
